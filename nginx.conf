#nginx config for DeezNuts
# 8/27/2018 : Skeetzo

#include /etc/nginx/modules-enabled/*;
#include /usr/share/nginx/modules-available/*;
#load_module "/etc/nginx/modules-enabled/50-mod-http-geoip.conf";

#user nobody;
user www-data;

#worker_processes auto;
worker_processes 1;

##
# Logging Settings
##
error_log  /etc/nginx/logs/error.log;
error_log  /etc/nginx/logs/error.log notice;
error_log  /etc/nginx/logs/error.log info;

pid /run/nginx.pid;

events {
    worker_connections 1024;
}

##
# HTTP
##
http {
    ##
    # Basic Settings
    ##
    include mime.types;
    default_type application/octet-stream;
    log_format   main '$remote_addr - $remote_user [$time_local]  $status '
    '"$request" $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /etc/nginx/logs/access.log;

    ##
    # Virtual Host Configs
    ##
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;

    server {

        listen 8080;

        # This URL provides RTMP statistics in XML
        location /stat {
            rtmp_stat all;

            # Use this stylesheet to view XML as web page
            # in browser
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            # XML stylesheet to view RTMP stats.
            # Copy stat.xsl wherever you want
            # and put the full directory path here
            root /path/to/stat.xsl/;
        }

        location /hls {
            # Serve HLS fragments
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
        }

        location /dash {
            # Serve DASH fragments
            root /tmp;
            add_header Cache-Control no-cache;
        }
    }
}

##
# RTMP
##
rtmp {

    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            record off;
            allow publish 76.91.217.22;
            allow publish 47.156.173.130;
            deny publish all;

            # watermark / cover and push to socials
            exec_push ffmpeg -re -i rtmp://localhost/live/$name -i watermark.png -filter_complex "overlay=x=(main_w-overlay_w)/2:y=h-th" -f mp4 rtmp://localhost/socials/$name;

            # push to deeznuts
            push alexdeeznuts.com:8433/live/stream.flv live=1;
        }

        application socials {
            # everything sent here is pushed to external live streaming
            live on;
            
            # Facebook
            #push rtmp://live-api.facebook.com:80/1735495809863085?ds=1&s_vt=api&a=AThxuu-z0KCANS1k;

            # Twitch
              # cockthulhu
            push rtmp://live-sjc.twitch.tv/app/live_103326489_lmasfklegL3QjcM7lFOZJMYiz1r2o0;

            # YouTube
              # Alex D. / JustAlexxxD
            push rtmp://a.rtmp.youtube.com/live2/mggx-3qyv-qj26-3a0k;
        }

        # HLS
        # For HLS to work please create a directory in tmpfs (/tmp/hls here)
        # for the fragments. The directory contents is served via HTTP (see
        # http{} section in config)
        #
        # Incoming stream must be in H264/AAC. For iPhones use baseline H264
        # profile (see ffmpeg example).
        # This example creates RTMP stream from movie ready for HLS:
        #
        # ffmpeg -loglevel verbose -re -i movie.avi  -vcodec libx264
        #    -vprofile baseline -acodec libmp3lame -ar 44100 -ac 1
        #    -f flv rtmp://localhost:1935/hls/movie
        #
        # If you need to transcode live stream use 'exec' feature.
        #
        application hls {
            live on;
            hls on;
            hls_path /tmp/hls;
        }

        # MPEG-DASH is similar to HLS

        application dash {
            live on;
            dash on;
            dash_path /tmp/dash;
        }
    }
}


#mail {
#   # See sample authentication script at:
#   # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
# 
#   # auth_http localhost/auth.php;
#   # pop3_capabilities "TOP" "USER";
#   # imap_capabilities "IMAP4rev1" "UIDPLUS";
# 
#   server {
#       listen     localhost:110;
#       protocol   pop3;
#       proxy      on;
#   }
# 
#   server {
#       listen     localhost:143;
#       protocol   imap;
#       proxy      on;
#   }
#}
